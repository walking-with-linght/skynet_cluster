# 服务器主动推送消息完整列表

本文档整理了所有服务器主动发送的推送消息，这些消息不需要客户端请求，由服务器在特定事件发生时主动推送。

---

## 一、推送消息特征

所有推送消息的共同特征：
- **`seq` 字段固定为 `0`** - 用于区分推送和响应
- **不需要客户端请求** - 服务器主动发送
- **不需要客户端响应** - 客户端只需接收处理

---

## 二、业务推送消息

### 2.1 聊天消息推送

**推送路由**: `chat.push`

**触发时机**: 
- 当有玩家在聊天频道发送消息时
- 向频道内所有在线玩家推送

**推送内容** (`ChatMsg`):
```json
{
  "rid": 123,              // 发送者角色ID
  "nickName": "玩家昵称",  // 发送者昵称
  "type": 0,               // 0=世界聊天, 1=联盟聊天
  "msg": "消息内容",       // 消息内容
  "time": 1234567890       // Unix时间戳
}
```

**推送范围**: 聊天频道内所有在线用户

**代码位置**: `server/chatserver/logic/group.go:62`

---

### 2.2 资源更新推送

**推送路由**: `roleRes.push`

**触发时机**: 
- 资源发生变化时（采集、消耗、生产等）
- 资源产量变化时
- 仓库容量变化时

**推送内容** (`RoleRes`):
```json
{
  "wood": 1000,            // 木材
  "iron": 1000,           // 铁矿
  "stone": 1000,          // 石头
  "grain": 1000,          // 粮食
  "gold": 1000,           // 金币
  "decree": 10,           // 政令
  "wood_yield": 100,      // 木材产量
  "iron_yield": 100,      // 铁矿产量
  "stone_yield": 100,     // 石头产量
  "grain_yield": 100,     // 粮食产量
  "gold_yield": 100,      // 金币产量
  "depot_capacity": 10000 // 仓库容量
}
```

**推送范围**: 资源所属的角色

**代码位置**: `server/slgserver/model/role_res.go:116`

---

### 2.3 角色属性推送

**推送路由**: `roleAttr.push`

**触发时机**: 
- 角色属性发生变化时
- 位置标记变化时
- 联盟信息变化时

**推送内容**: `null` (仅通知更新，无具体数据)

**推送范围**: 属性所属的角色

**代码位置**: `server/slgserver/model/role_attribute.go:148`

**注意**: 客户端收到此推送后，可能需要主动请求获取最新属性数据

---

### 2.4 城市更新推送

**推送路由**: `roleCity.push`

**触发时机**: 
- 城市信息发生变化时
- 城市被占领时
- 城市耐久变化时
- 城市等级变化时

**推送内容** (`MapRoleCity`):
```json
{
  "cityId": 1,
  "rid": 123,
  "name": "城市名称",
  "union_id": 0,          // 联盟ID
  "union_name": "",       // 联盟名字
  "parent_id": 0,        // 上级ID
  "x": 100,
  "y": 200,
  "is_main": true,        // 是否主城
  "level": 1,             // 城市等级
  "cur_durable": 1000,    // 当前耐久
  "max_durable": 1000,    // 最大耐久
  "occupy_time": 1234567890  // 占领时间（毫秒）
}
```

**推送范围**: 
- 城市所有者
- 视野范围内的玩家（如果启用视野系统）

**代码位置**: `server/slgserver/model/map_role_city.go:138`

---

### 2.5 建筑更新推送

**推送路由**: `roleBuild.push`

**触发时机**: 
- 建筑建造完成时
- 建筑升级完成时
- 建筑被占领时
- 建筑耐久变化时
- 建筑被放弃时

**推送内容** (`MapRoleBuild`):
```json
{
  "rid": 123,
  "RNick": "角色昵称",
  "name": "建筑名称",
  "union_id": 0,
  "union_name": "",
  "parent_id": 0,
  "x": 100,
  "y": 200,
  "type": 1,              // 建筑类型
  "level": 1,             // 建筑等级
  "op_level": 0,          // 升级目标等级
  "cur_durable": 1000,    // 当前耐久
  "max_durable": 1000,    // 最大耐久
  "defender": 0,          // 防御等级
  "occupy_time": 1234567890,
  "end_time": 1234567890,     // 建造完成时间
  "giveUp_time": 0            // 放弃时间
}
```

**推送范围**: 
- 建筑所有者
- 视野范围内的玩家（如果启用视野系统）

**代码位置**: `server/slgserver/model/map_role_build.go:279`

---

### 2.6 武将更新推送

**推送路由**: `general.push`

**触发时机**: 
- 武将属性变化时
- 武将上阵/下阵时
- 武将升级时
- 武将合成时
- 武将加点时
- 武将技能变化时

**推送内容** (`General`):
```json
{
  "id": 1,
  "cfgId": 1001,          // 配置ID
  "physical_power": 100,  // 体力
  "order": 0,             // 0=未上阵, 1-5=队伍编号
  "level": 1,             // 等级
  "exp": 0,               // 经验
  "cityId": 1,
  "curArms": 1,           // 当前兵种
  "hasPrPoint": 0,        // 拥有属性点
  "usePrPoint": 0,        // 已使用属性点
  "attack_distance": 1,   // 攻击距离
  "force_added": 0,       // 武力加成
  "strategy_added": 0,    // 谋略加成
  "defense_added": 0,     // 防御加成
  "speed_added": 0,       // 速度加成
  "destroy_added": 0,     // 破坏加成
  "star_lv": 0,           // 星级等级
  "star": 5,              // 最大星级
  "parentId": 0,          // 父武将ID
  "skills": [             // 技能列表
    {
      "id": 1,
      "lv": 1,
      "cfgId": 2001
    }
  ],
  "state": 0              // 状态
}
```

**推送范围**: 武将所属的角色

**代码位置**: `server/slgserver/model/general.go:322`

---

### 2.7 军队更新推送

**推送路由**: `army.push`

**触发时机**: 
- 军队移动时
- 军队状态变化时
- 军队到达目的地时
- 军队返回时
- 军队配置变化时
- 征兵进度更新时

**推送内容** (`Army`):
```json
{
  "id": 1,
  "cityId": 1,
  "union_id": 0,
  "order": 1,             // 第几队，1-5
  "generals": [1, 2, 0],  // 武将ID数组
  "soldiers": [1000, 2000, 0],  // 士兵数量数组
  "con_times": [1234567890, 0, 0],  // 征兵完成时间数组
  "con_cnts": [500, 0, 0],     // 征兵数量数组
  "cmd": 0,               // 命令：0=空闲, 1=攻击, 2=驻军, 3=返回, 4=开荒, 5=调兵
  "state": 0,             // 状态：0=running, 1=stop
  "from_x": 100,
  "from_y": 200,
  "to_x": 150,
  "to_y": 250,
  "start": 1234567890,    // 出征开始时间
  "end": 1234567900       // 出征结束时间
}
```

**推送范围**: 
- 军队所有者
- 视野范围内的玩家（如果启用视野系统）
- 军队移动过程中，会持续推送位置更新

**代码位置**: `server/slgserver/model/army.go:320`

**特殊说明**: 军队移动时会根据当前位置计算实时坐标并推送

---

### 2.8 联盟申请推送

**推送路由**: `unionApply.push`

**触发时机**: 
- 有玩家申请加入联盟时
- 向联盟的盟主和副盟主推送

**推送内容** (`ApplyItem`):
```json
{
  "id": 1,                // 申请ID
  "rid": 123,             // 申请者角色ID
  "nick_name": "玩家昵称"  // 申请者昵称
}
```

**推送范围**: 联盟的盟主和副盟主

**代码位置**: `server/slgserver/model/coalition.go:166`

---

### 2.9 战报推送

**推送路由**: `warReport.push`

**触发时机**: 
- 战斗结束时
- 向攻击者和防御者推送

**推送内容** (`WarReportPush`):
```json
{
  "list": [
    {
      "id": 1,
      "a_rid": 123,        // 攻击者rid
      "d_rid": 456,        // 防御者rid
      "b_a_army": "string",  // 攻击方初始军队
      "b_d_army": "string",  // 防御方初始军队
      "e_a_army": "string",  // 攻击方结束军队
      "e_d_army": "string",  // 防御方结束军队
      "b_a_general": "string",  // 攻击方初始武将
      "b_d_general": "string",  // 防御方初始武将
      "e_a_general": "string",  // 攻击方结束武将
      "e_d_general": "string",  // 防御方结束武将
      "result": 2,         // 0=失败, 1=打平, 2=胜利
      "rounds": "string",  // 回合详情
      "a_is_read": false,  // 攻击者是否已读
      "d_is_read": false,  // 防御者是否已读
      "destroy": 100,      // 破坏耐久
      "occupy": 0,         // 是否占领
      "x": 100,
      "y": 200,
      "ctime": 1234567890  // 时间戳（毫秒）
    }
  ]
}
```

**推送范围**: 战斗的参与双方（攻击者和防御者）

**代码位置**: `server/slgserver/model/war_report.go:91`

---

### 2.10 技能更新推送

**推送路由**: `skill.push`

**触发时机**: 
- 技能装备/卸下时
- 技能升级时
- 技能使用武将列表变化时

**推送内容** (`Skill`):
```json
{
  "id": 1,                // 技能ID
  "cfgId": 2001,         // 技能配置ID
  "generals": [1, 2, 3]  // 装备该技能的武将ID列表
}
```

**推送范围**: 技能所属的角色

**代码位置**: `server/slgserver/model/skill.go:129`

---

## 三、系统推送消息

### 3.1 握手协议

**推送路由**: `handshake`

**触发时机**: 
- 连接建立后，如果服务器需要加密（`needSecret=true`）
- 服务器主动发送，不需要客户端请求

**推送内容** (`Handshake`):
```json
{
  "key": "16位随机字符串"  // 加密密钥
}
```

**特殊说明**: 
- 如果 `key` 为空字符串，表示不需要加密
- 客户端收到后，保存 `key`，后续通信使用此密钥加密/解密
- 这是连接建立后的第一个消息

**代码位置**: `net/serverconn.go:232`

---

### 3.2 账号被抢登录

**推送路由**: `robLogin`

**触发时机**: 
- 同一账号在其他地方登录时
- 向旧连接推送，通知被抢登录

**推送内容**: `null`

**推送范围**: 被抢登录的旧连接

**代码位置**: `net/connMgr.go:62`

**业务逻辑**: 
- 当新连接登录时，如果检测到该账号已有连接，会断开旧连接
- 旧连接会收到 `robLogin` 推送，客户端应提示用户账号在其他地方登录

---

### 3.3 需要登录

**推送路由**: `account.pleaseLogin`

**触发时机**: 
- 客户端请求需要登录验证的接口，但未登录时
- 中间件 `CheckLogin()` 检测到未登录时推送

**推送内容**: `null`

**推送范围**: 未登录的连接

**代码位置**: `middleware/check_login.go:19`

**业务逻辑**: 
- 客户端收到此推送后，应引导用户进行登录
- 这是中间件验证失败时的提示消息

---

## 四、推送机制说明

### 4.1 视野系统

部分推送消息（如 `army.push`、`roleBuild.push`、`roleCity.push`）支持视野系统：

- **视野范围**: 8x6 格子
- **推送规则**: 只有视野范围内的玩家才能收到推送
- **位置计算**: 根据 `Position()` 和 `TPosition()` 方法计算推送范围

**代码位置**: `net/connMgr.go:146`

### 4.2 推送目标

推送消息的接收者由 `BelongToRId()` 方法决定：

- **个人推送**: 只推送给数据所有者（如资源、武将）
- **视野推送**: 推送给视野范围内的玩家（如建筑、军队）
- **频道推送**: 推送给频道内所有玩家（如聊天）
- **特定推送**: 推送给特定角色（如联盟申请推送给盟主）

### 4.3 推送时机

推送消息在以下时机触发：

1. **数据变更时**: 当数据模型调用 `SyncExecute()` 时，会自动触发推送
2. **业务逻辑触发**: 在业务逻辑中主动调用 `Push()` 方法
3. **定时更新**: 某些数据（如资源产量）可能定时推送更新

---

## 五、推送消息总结表

| 推送路由 | 类型 | 触发时机 | 推送范围 | 数据内容 |
|---------|------|---------|---------|---------|
| `chat.push` | 业务 | 聊天消息发送 | 聊天频道内所有用户 | ChatMsg |
| `roleRes.push` | 业务 | 资源变化 | 资源所有者 | RoleRes |
| `roleAttr.push` | 业务 | 属性变化 | 属性所有者 | null |
| `roleCity.push` | 业务 | 城市变化 | 所有者+视野内玩家 | MapRoleCity |
| `roleBuild.push` | 业务 | 建筑变化 | 所有者+视野内玩家 | MapRoleBuild |
| `general.push` | 业务 | 武将变化 | 武将所有者 | General |
| `army.push` | 业务 | 军队变化/移动 | 所有者+视野内玩家 | Army |
| `unionApply.push` | 业务 | 联盟申请 | 盟主+副盟主 | ApplyItem |
| `warReport.push` | 业务 | 战斗结束 | 战斗双方 | WarReportPush |
| `skill.push` | 业务 | 技能变化 | 技能所有者 | Skill |
| `handshake` | 系统 | 连接建立 | 新连接 | Handshake |
| `robLogin` | 系统 | 账号被抢登录 | 旧连接 | null |
| `account.pleaseLogin` | 系统 | 未登录访问 | 未登录连接 | null |

---

## 六、客户端处理建议

### 6.1 推送消息识别

客户端应通过以下方式识别推送消息：

```javascript
if (message.seq === 0) {
    // 这是推送消息
    handlePush(message.name, message.msg);
} else {
    // 这是响应消息
    handleResponse(message.seq, message);
}
```

### 6.2 推送消息处理

1. **聊天推送**: 直接显示在聊天界面
2. **资源推送**: 更新资源显示
3. **建筑/城市推送**: 更新地图显示
4. **军队推送**: 更新军队位置和状态
5. **战报推送**: 显示新战报提示
6. **系统推送**: 
   - `robLogin`: 提示用户账号在其他地方登录，断开连接
   - `account.pleaseLogin`: 引导用户登录

### 6.3 推送消息去重

某些推送消息可能会频繁发送（如军队移动），客户端应：
- 使用消息ID或时间戳去重
- 合并短时间内相同类型的推送
- 避免重复刷新UI

---

## 七、注意事项

1. **推送消息的 `seq` 始终为 0**，这是识别推送的唯一标识
2. **推送消息不需要响应**，客户端只需接收处理
3. **推送消息可能丢失**，客户端应设计容错机制
4. **视野系统推送**：只有视野范围内的玩家才能收到，客户端应合理管理视野
5. **推送频率**：某些推送可能很频繁（如军队移动），客户端应做节流处理

---

**文档版本**: 1.0  
**最后更新**: 2024

